<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Crazy Web Man</title>
    <style>
      #appleImage {
        height: 400px;
        width: 811px;
        display: none;
      }
      canvas {
        border: 2px solid red;
        display: block;
        position: absolute;
      }
      #previous,
      #current {
        width: 50px;
        height: 50px;
        border: 2px solid #000000;
        margin-right: 16px;
      }
      #canvases {
        position: relative;
      }
      #canvas {
        opacity: 0;
      }
    </style>
  </head>
  <body>
    <img id="appleImage" src="IMGs/WebManTestCapture.PNG" />
    <div id="previous"></div>
    <div id="current"></div>
    <h1>contrast: <span id="contrast"></span></h1>
    <div id="canvases">
      <canvas id="canvas"></canvas>
      <canvas id="overlay"></canvas>
    </div>

    <script>
      function toStandardRgb(rgb) {
        return rgb.map((colorChannel) => colorChannel / 255);
      }
      function toLinearRgb(standardRgb) {
        return standardRgb.map((colorChannel) =>
          colorChannel <= 0.03928
            ? colorChannel / 12.92
            : Math.pow((colorChannel + 0.55) / 1.055, 2.4)
        );
      }
      function sum(arr) {
        return arr.reduce(
          (accumulator, currentValue) => accumulator + currentValue,
          0
        );
      }
      function luminance(rgb) {
        const [red, green, blue] = toLinearRgb(toStandardRgb(rgb));
        return sum([red * 0.2126, green * 0.7152, blue * 0.0722]);
      }
      const contrast = (lum1, lum2) =>
        lum1 > lum2
          ? (lum2 + 0.05) / (lum1 + 0.05)
          : (lum1 + 0.05) / (lum2 + 0.05);
    </script>
    <script>
      const contrastElement = document.getElementById("contrast");
      const appleImage = document.getElementById("appleImage");
      const canvas = document.getElementById("canvas");
      overlay = document.getElementById("overlay");
      const previous = document.getElementById("previous");
      const current = document.getElementById("current");
      let prevRgb = [255, 255, 255];
      let context = canvas.getContext("2d");
      let imageData = [];
      function pixelBelowIndex(pixelIndex, imageData) {
        return pixelIndex + canvas.width * 4;
      }
      function indexToCoord(pixelIndex, width, height) {
        const yCoord = Math.floor(pixelIndex / (width * 4));
        const xCoord = (pixelIndex - yCoord * (width * 4)) / 4;

        return { x: xCoord, y: yCoord };
      }
      let handleImageLoad = () => {
        canvas.width = appleImage.width;
        canvas.height = appleImage.height;
        overlay.width = appleImage.width;
        overlay.height = appleImage.height;
        context.drawImage(appleImage, 0, 0);
        imageData = context.getImageData(0, 0, canvas.width, canvas.height)
          .data;
        const ctx = overlay.getContext("2d");
        for (
          let pixelIndex = 0;
          pixelIndex < imageData.length - canvas.width * 4;
          pixelIndex += 4
        ) {
          // console.log(canvas.width);
          // console.log(pixelIndex);
          const RGBA_SIZE = 4;
          const aboveRgba = imageData.slice(pixelIndex, pixelIndex + RGBA_SIZE);
          let belowIndex = pixelBelowIndex(pixelIndex, imageData);
          const belowRgba = imageData.slice(belowIndex, belowIndex + RGBA_SIZE);
          const aboveLuminance = luminance(aboveRgba);
          const belowLuminance = luminance(belowRgba);
          const c = contrast(aboveLuminance, belowLuminance);
          const pixelCoord = indexToCoord(
            pixelIndex,
            canvas.width,
            canvas.height
          );
          // let testC;
          // if (c - 0.3 < 0) {
          //   testC = 0;
          // } else if (c < 1 && c - 0.3 > 0) {
          //   testC = c - 0.3;
          // } else {
          //   testC = 1;
          // }
          // if (c < 1) {
          //   testC = 0;
          // } else {
          //   testC = 1;
          // }
          // console.log(pixelCoord);
          // ctx.fillStyle = `rgba(255,0,0,1)`;
          ctx.fillStyle = `rgba(255,0,0,${1 - c})`;
          ctx.fillRect(pixelCoord.x, pixelCoord.y, 1, 1);
          // ctx.putImageData([255, 0, 0, 1 - c], pixelCoord.x, pixelCoord.y);
        }
        // .drawImage(appleImage, 0, 0, canvas.width, canvas.height);
      };
      appleImage.addEventListener("load", handleImageLoad);

      // canvas.addEventListener("mousemove", (event) => {
      //   // console.log(event);
      //   const x = event.layerX;
      //   const y = event.layerY;
      //   const data = context.getImageData(x, y, 1, 1).data;
      //   let rgbString = (rgb) => `rgb(${rgb[0]},${rgb[1]},${rgb[2]})`;
      //   console.log(rgbString(data));
      //   previous.style.background = rgbString(prevRgb);
      //   current.style.background = rgbString(data);
      //   const currentLuminance = luminance(data);
      //   const previousLuminance = luminance(prevRgb);
      //   contrastElement.innerText = contrast(
      //     currentLuminance,
      //     previousLuminance
      //   );
      //   prevRgb = data;
      // });
    </script>
  </body>
</html>
